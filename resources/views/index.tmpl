{{ define "index.tmpl"}}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
crossorigin=""/>

{{ template "templates/layout.tmpl" .}}
{{ template "layouts/script.tmpl" . }}
<!-- Start about-info Area -->
<section class="price-area section-gap">
    <section id="peta_indonesia" class="about-info-area section-gap">
        <div class="container">
            <div class="title text-center">
                <h1 class="mb-10">Peta Lokasi Kejadian</h1>
                <br>
            </div>
            <div class="row align-items-center">
                <div id="map" style="width:100%;height:420px;"></div>

                <!-- Script LeafletJS -->
                <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
                    integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

                <script type="text/javascript">
                    var locationsKeamanan = [];
                    var locationsKeselamatan = [];
                    var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: 'Â© OpenStreetMap'
                    });
                    var osmHOT = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Tiles style by <a href="https://www.hotosm.org/" target="_blank">Humanitarian OpenStreetMap Team</a> hosted by <a href="https://openstreetmap.fr/" target="_blank">OpenStreetMap France</a>'
                    });
                    var OpenTopoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                        maxZoom: 17,
                        attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
                    });

                    // Set default active layers
                    var defaultBaseLayer = osm;
                    var defaultOverlayLayers = [L.layerGroup(locationsKeamanan), L.layerGroup(locationsKeselamatan)];

                    var map = new L.Map('map', {
                        center: { lat: -2.548926, lng: 118.0148634 },
                        zoom: 5,
                        layers: [defaultBaseLayer,osmHOT,OpenTopoMap, ...defaultOverlayLayers]
                    });

                    var baseMaps = {
                        "OpenStreetMap": osm,
                        "OpenStreetMap.HOT": osmHOT,
                        "OpenTopoMap": OpenTopoMap
                    };

                    var overlayMaps = {
                        "Pelanggaran": L.layerGroup(locationsKeamanan),
                        "Keselamatan": L.layerGroup(locationsKeselamatan)
                    };

                    var layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);

                    function setMarkers(map, locations, initial) {
                        locations.forEach((a) => {
                            var marker = new L.marker([a.latitude, a.longitude]).bindPopup(a.nama_kapal);
                            if (initial == 1) {
                                locationsKeamanan.push(marker);
                            } else if (initial == 2) {
                                locationsKeselamatan.push(marker);
                            }
                            marker.addTo(map);
                        });

                        // Update layer control
                        map.removeControl(layerControl);
                        overlayMaps = {
                            "Pelanggaran": L.layerGroup(locationsKeamanan),
                            "Keselamatan": L.layerGroup(locationsKeselamatan)
                        };
                        layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);
                    }

                    async function getDataKeamanan() {
                        return new Promise((resolve, reject) => {
                            $.ajax({
                                url: "{{.dataKeamananURL}}",
                                method: "POST",
                                data: {
                                    nik: {{.data.nik }},
                                    tanggal_awal: "2024-03-01",
                                    tanggal_akhir: "2024-10-10"
                                },
                                success: function(response) {
                                    setMarkers(map, response.data.data_kejadian_keamanan, 1);
                                    resolve();
                                },
                                error: function(response) {
                                    Swal.fire({
                                        type: 'error',
                                        title: 'Oops!',
                                        text: response.responseJSON.message
                                    });
                                    reject(response);
                                }
                            });
                        });
                    }

                    async function getDataKeselamatan() {
                        return new Promise((resolve, reject) => {
                            $.ajax({
                                url: "{{.dataKeselamatanURL}}",
                                method: "POST",
                                data: {
                                    nik: {{.data.nik }},
                                    tanggal_awal: "2024-03-01",
                                    tanggal_akhir: "2024-10-10"
                                },
                                success: function(response) {
                                    setMarkers(map, response.data.data_kejadian_keselamatan, 2);
                                    resolve();
                                },
                                error: function(response) {
                                    Swal.fire({
                                        type: 'error',
                                        title: 'Oops!',
                                        text: response.responseJSON.message
                                    });
                                    reject(response);
                                }
                            });
                        });
                    }

                    // Call the function to get data and set markers
                    getDataKeamanan();
                    getDataKeselamatan();
                </script>
            </div>
        </div>
    </section>
</section>
{{ template "layouts/footer.tmpl" . }}
{{ end }}
